name: Build Release

on:
    push:
        branches:
            - main

permissions:
    contents: write

jobs:
    build:
        runs-on: windows-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  submodules: recursive

            -   name: Setup MSBuild
                uses: microsoft/setup-msbuild@v2

            - name: Generate Auth File
              shell: pwsh
              env:
                  SECRET_KEY: ${{ secrets.API_AUTH_KEY }}
              run: |
                  $filePath = "${{ github.workspace }}\MemoUploader\Api\ApiSecrets.cs"
                  $content = @"
                  namespace MemoUploader.Api;
                  public class ApiSecrets
                  {
                      public const string AuthKey = "$env:SECRET_KEY";
                  }
                  "@
                  Set-Content -Path $filePath -Value $content

            - name: Restore NuGet packages
              run: nuget restore Plugin.sln

            - name: Build (Release)
              run: msbuild Plugin.sln /p:Configuration=Release

            - name: Read Version
              id: version
              shell: pwsh
              run: |
                  $content = Get-Content MemoUploader/Properties/AssemblyInfo.cs -Raw
                  if ($content -match 'AssemblyVersion\("([^"]+)"\)') {
                    $version = $matches[1]
                    "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
                  } else {
                    throw "AssemblyVersion not found"
                  }

            - name: Pack Release Zip
              id: pack_zip
              shell: pwsh
              run: |
                  $version = "${{ steps.version.outputs.version }}"
                  $releaseDir = "MemoUploader/bin/Release"
                  $zipName = "MemoUploader-v$version.zip"

                  $stagingDir = "staging_temp"
                  New-Item -ItemType Directory -Path $stagingDir -Force

                  $filesToPack = @(
                      "MemoUploader.dll",
                      "System.Threading.Tasks.Dataflow.dll",
                      "Newtonsoft.Json.dll"
                  )

                  foreach ($file in $filesToPack) {
                      $srcPath = Join-Path $releaseDir $file
                      if (Test-Path $srcPath) {
                          Copy-Item $srcPath -Destination $stagingDir
                      }
                  }

                  Compress-Archive -Path "$stagingDir/*" -DestinationPath $zipName

            - name: Create git tag
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag v${{ steps.version.outputs.version }}
                  git push origin v${{ steps.version.outputs.version }}

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.version.outputs.version }}
                  files: MemoUploader-v*.zip
